# Version 0.3
# Command system/custom/add packages ....
$packagesinstall = <<-SCRIPT
	# Package installing
	echo "# Splunk RPM installation"
	sudo yum localinstall /vagrant/splunk-8.0.6-152fb4b2bb96-linux-2.6-x86_64.rpm -y

  	# Setup Splunk config
	echo "# Set permissions on Splunk folder"
	sudo chown -R vagrant:vagrant /opt/splunk

	echo "# Splunk activation on boot with Vagrant user"
	sudo /opt/splunk/bin/splunk enable boot-start  -systemd-managed 1 --accept-license -user vagrant --seed-passwd changeme
	
	echo "# Launch Splunk"
	sudo /opt/splunk/bin/splunk start  --no-prompt 
SCRIPT

#Get IP to display after vagrant up
$getip= <<-SCRIPT
	echo "IP of $(hostname) : "
	ip -4 addr sh eth1
SCRIPT

#Message post up
$postupmessage = <<-SCRIPT
	Congratulations VM/box available.
  	Generate by Vagrant !
SCRIPT

#Customise OS env
$customenv= <<-SCRIPT
	echo "Custom environnement"
  #Bash profile
  echo "Set Bash profile to all users"
	sudo curl -sk "https://raw.githubusercontent.com/alasta/dotfiles/master/.bash_profile_vagrant"  -o /etc/profile.d/bash_profile.sh
	#inputrc
	echo "Set inputrc"
	curl -sk "https://raw.githubusercontent.com/alasta/dotfiles/master/.inputrc" -o INPUTRC
	sudo cat INPUTRC >> /etc/inputrc
	rm -f INPUTRC

	#Set timezone
	echo "# Set timezone"
	timedatectl set-timezone 'Europe/Paris'

SCRIPT

#Config box
Vagrant.configure("2") do |config|
	config.vm.define "vm1" do |vm1|
		vm1.vm.provider "virtualbox" do |v|
 			v.memory = 2048
  		v.cpus = 2
		end
		vm1.vm.box = "centos/7"
		vm1.vm.hostname = 'vm1'
		vm1.vm.box_url = "centos/7"
		vm1.vm.network "forwarded_port", guest: 8000, host: 8000
		# vm1.vm.network "forwarded_port", guest: 9997, host: 9997
		vm1.vm.network "forwarded_port", guest: 8089, host: 8089 
		vm1.vm.network "public_network", bridge: "en0: Wi-Fi (AirPort)", auto_config: false
		vm1.vm.provision "file", source: "~/Downloads/splunk-8.0.6-152fb4b2bb96-linux-2.6-x86_64.rpm", destination: "/vagrant/"
		vm1.vm.provision "shell", inline: $packagesinstall
		vm1.vm.provision "shell", inline: $customenv
		vm1.vm.provision "shell", inline: $getip, run: "always"
		vm1.vm.post_up_message = $postupmessage
		#vm1.vm.provision "shell", inline: "ip -4 addr sh eth1", run: "always"
	end
end
